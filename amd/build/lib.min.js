define("mod_maici/lib",["exports"],(function(_exports){function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}function _createForOfIteratorHelper(o,allowArrayLike){var it="undefined"!=typeof Symbol&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=function(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}(o))||allowArrayLike&&o&&"number"==typeof o.length){it&&(o=it);var i=0,F=function(){};return{s:F,n:function(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}},e:function(_e){throw _e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var err,normalCompletion=!0,didErr=!1;return{s:function(){it=it.call(o)},n:function(){var step=it.next();return normalCompletion=step.done,step},e:function(_e2){didErr=!0,err=_e2},f:function(){try{normalCompletion||null==it.return||it.return()}finally{if(didErr)throw err}}}}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0;var questionString="Ask a question...",errorString="An error occurred! Please try again later.";_exports.init=function(data){var _ref,_ref2,blockId=data.blockId,api_type=data.api_type,persistConvo=data.persistConvo,usertokenvalidation=data.usertokenvalidation;"assistant"===api_type&&(chatData=localStorage.getItem("block_openai_chat_data"),chatData?(chatData=JSON.parse(chatData),chatData[blockId]&&chatData[blockId].threadId&&"1"===persistConvo?fetch("".concat(M.cfg.wwwroot,"/mod/maici/api/thread.php"),{method:"POST",body:JSON.stringify({blockId:blockId,threadId:chatData[blockId].threadId})}).then((function(response){return response.json()})).then((function(data){var _step,_iterator=_createForOfIteratorHelper(data);try{for(_iterator.s();!(_step=_iterator.n()).done;){var message=_step.value;addToChatLog("user"===message.role?"user":"bot",message.message)}}catch(err){_iterator.e(err)}finally{_iterator.f()}})).catch((function(error){chatData[blockId]={},localStorage.setItem("block_openai_chat_data",JSON.stringify(chatData))})):chatData[blockId]={}):chatData=_defineProperty({},blockId,{}),localStorage.setItem("block_openai_chat_data",JSON.stringify(chatData))),document.querySelector("#openai_input").addEventListener("keyup",(_ref=_asyncToGenerator(regeneratorRuntime.mark((function _callee(e){return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:if(13!==e.which||""===e.target.value){_context.next=7;break}return _context.next=3,checkUserTokenUsage(blockId,usertokenvalidation);case 3:if(!_context.sent){_context.next=7;break}addToChatLog("user",e.target.value),createCompletion(e.target.value,blockId,api_type),e.target.value="";case 7:case"end":return _context.stop()}}),_callee)}))),function(_x){return _ref.apply(this,arguments)})),document.querySelector("#go").addEventListener("click",(_ref2=_asyncToGenerator(regeneratorRuntime.mark((function _callee2(e){var input;return regeneratorRuntime.wrap((function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:if(""===(input=document.querySelector("#openai_input")).value){_context2.next=8;break}return _context2.next=4,checkUserTokenUsage(blockId,usertokenvalidation);case 4:if(!_context2.sent){_context2.next=8;break}addToChatLog("user",input.value),createCompletion(input.value,blockId,api_type),input.value="";case 8:case"end":return _context2.stop()}}),_callee2)}))),function(_x2){return _ref2.apply(this,arguments)})),document.querySelector("#refresh").addEventListener("click",(function(e){clearHistory(blockId)})),require(["core/str"],(function(str){str.get_strings([{key:"askaquestion",component:"mod_maici"},{key:"erroroccurred",component:"mod_maici"}]).then((function(results){questionString=results[0],errorString=results[1]}))}))};var _ref3,addToChatLog=function(type,message){var messageContainer=document.querySelector("#openai_chat_log"),messageElem=document.createElement("div");messageElem.classList.add("openai_message");var _step2,_iterator2=_createForOfIteratorHelper(type.split(" "));try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var className=_step2.value;messageElem.classList.add(className)}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}var messageText=document.createElement("span");messageText.innerHTML=message,messageElem.append(messageText),messageContainer.append(messageElem),messageText.offsetWidth&&(messageElem.style.width=messageText.offsetWidth+40+"px"),messageContainer.scrollTop=messageContainer.scrollHeight},clearHistory=function(blockId){chatData=localStorage.getItem("block_openai_chat_data"),chatData&&(chatData=JSON.parse(chatData),chatData[blockId]&&(chatData[blockId]={},localStorage.setItem("block_openai_chat_data",JSON.stringify(chatData)))),document.querySelector("#openai_chat_log").innerHTML=""},createCompletion=function(message,blockId,api_type){var chatData,threadId=null;"assistant"===api_type&&((chatData=localStorage.getItem("block_openai_chat_data"))?(chatData=JSON.parse(chatData))[blockId]&&(threadId=chatData[blockId].threadId||null):chatData=_defineProperty({},blockId,{}));var history=buildTranscript();document.querySelector("#control_bar").classList.add("disabled"),document.querySelector("#openai_input").classList.remove("error"),document.querySelector("#openai_input").placeholder=questionString,document.querySelector("#openai_input").blur(),addToChatLog("bot loading","..."),fetch("".concat(M.cfg.wwwroot,"/mod/maici/api/completion.php"),{method:"POST",body:JSON.stringify({message:message,history:history,blockId:blockId,threadId:threadId})}).then((function(response){var messageContainer=document.querySelector("#openai_chat_log");return messageContainer.removeChild(messageContainer.lastElementChild),document.querySelector("#control_bar").classList.remove("disabled"),response.ok?response.json():response.json().then((function(error){var errorMessage="";throw Object.keys(error.error).forEach((function(attr){errorMessage+="".concat(attr,": ").concat(error.error[attr],"\n")})),addToChatLog("alert",errorMessage),Error(error.error.message)}))})).then((function(data){try{addToChatLog("bot",data.message),data.thread_id&&(chatData[blockId].threadId=data.thread_id,localStorage.setItem("block_openai_chat_data",JSON.stringify(chatData)))}catch(error){console.log(error),addToChatLog("bot",data.error.message)}document.querySelector("#openai_input").focus()})).catch((function(error){console.log(error),document.querySelector("#openai_input").classList.add("error"),document.querySelector("#openai_input").placeholder=errorString}))},buildTranscript=function(){var transcript=[];return document.querySelectorAll(".openai_message").forEach((function(message,index){if(index!==document.querySelectorAll(".openai_message").length-1){var user=userName;message.classList.contains("bot")&&(user=assistantName),transcript.push({user:user,message:message.innerText})}})),transcript},checkUserTokenUsage=(_ref3=_asyncToGenerator(regeneratorRuntime.mark((function _callee3(blockId,usertokenvalidation){return regeneratorRuntime.wrap((function(_context3){for(;;)switch(_context3.prev=_context3.next){case 0:return _context3.abrupt("return",new Promise((function(resolve,reject){usertokenvalidation?require(["jquery","core/ajax","core/notification","core/str","core/pending"],(function($,Ajax,Notification,str,Pending){var pendingPromise=new Pending("mod_maici/lib:init");Ajax.call([{methodname:"mod_maici_validate_user_tokens",args:{cmid:blockId}}])[0].then((function(response){!1===response.usertokenvalidation?($("#maici_container").addClass("overlay"),Notification.alert(str.get_string("chatwindowinfo","mod_maici"),str.get_string("outoftokens","mod_maici"),str.get_string("chatwindowbutton","mod_maici")),resolve(!1)):resolve(!0)})).always(pendingPromise.resolve).catch((function(error){reject(error)}))})):resolve(!0)})));case 1:case"end":return _context3.stop()}}),_callee3)}))),function(_x3,_x4){return _ref3.apply(this,arguments)})}));

//# sourceMappingURL=lib.min.js.map